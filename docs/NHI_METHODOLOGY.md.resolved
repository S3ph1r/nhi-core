# NHI Methodology

> **Version:** 1.0  
> **Last Updated:** 2026-01-30  
> **Purpose:** Complete development philosophy and standards for NHI-CORE ecosystem

---

## 1. Core Philosophy

### 1.1 Guiding Principles

| Principle | Description |
|-----------|-------------|
| Document | Purpose | Path |
|----------|---------|------|
| **GLOBAL_CONTEXT.md** | Logical architecture | Root of Projects |
| **NHI_METHODOLOGY.md** | Operational rules | `docs/` |
| **IMPLEMENTATION_V1.1.md** | **SSOT** Technical Specs | `docs/specs/` |
| **NHI_DESIGN_SYSTEM.md** | UI/UX Standards | `docs/specs/` |

**Before ANY remote operation:** Consult GLOBAL_CONTEXT.md first. Then check Implementation Guide for technical details.
| **Secure by Default** | Credentials encrypted, no plaintext allowed |

### 1.2 The Golden Rules

1. **Never hardcode IPs** - Use service registry or DNS
2. **Never store passwords in code** - Use Age-encrypted vault
3. **One service = One LXC** - Clean separation of concerns
4. **Document everything** - If it's not documented, it doesn't exist
5. **Automate everything** - Manual steps should be rare exceptions

---

## 2. Project Structure

### 2.1 Standard Project Layout

```
project-name/
├── .agent/
│   └── workflows/           # Agent-specific workflows
├── docs/
│   ├── README.md           # Project overview
│   └── architecture.md     # Technical architecture
├── src/                    # Source code
│   ├── api/               # API endpoints
│   ├── core/              # Business logic
│   └── utils/             # Utilities
├── tests/                  # Test files
├── docker/
│   ├── Dockerfile         # Container definition
│   └── docker-compose.yaml
├── project_manifest.md     # NHI project manifest
└── .env.example           # Environment template (NO secrets!)
```

### 2.2 Naming Conventions

| Type | Convention | Example |
|------|------------|---------|
| **LXC hostname** | `service-name` | `postgres-db`, `warroom-api` |
| **Docker container** | `project-service` | `nhi-dashboard-api` |
| **Python packages** | `snake_case` | `nhi_core`, `service_registry` |
| **API endpoints** | `/api/v1/resource` | `/api/v1/services` |
| **Config files** | `lowercase.yaml` | [config.yaml](file:///N:/nhi-data/config.yaml), `secrets.yaml` |

### 2.3 Port Allocation

| Range | Purpose |
|-------|---------|
| 80, 443 | Reverse Proxy (Traefik/Nginx) |
| 5432 | PostgreSQL (centralized) |
| 6379 | Redis (centralized) |
| 8000-8099 | NHI Core Services |
| 8100-8199 | User Applications |
| 3000-3099 | Frontend Development |
| 9090-9099 | Monitoring (Prometheus) |
| 9100-9199 | Metrics Exporters |

---

## 3. Development Workflow

### 3.1 Standard Flow

```
1. IDEATE
   └── Discuss requirements with user
   └── Consult TECH_STACK.md for technology choices

2. DESIGN
   └── Create project_manifest.md
   └── Define API contracts
   └── Plan data models

3. SCAFFOLD
   └── Use templates from nhi-data/templates/
   └── Create standard directory structure
   └── Initialize git repository

4. DEVELOP
   └── Follow coding standards
   └── Write tests alongside code
   └── Document as you go

5. TEST
   └── Unit tests locally
   └── Integration tests in LXC
   └── Health check verification

6. DEPLOY
   └── Build Docker image
   └── Deploy to target LXC
   └── Register in NHI service registry

7. VERIFY
   └── Check service health
   └── Verify context regeneration
   └── Confirm .cursorrules updated
```

### 3.2 Import External Project Flow

When user brings a design from external LLM:

```
1. ANALYZE
   └── Compare against NHI_STANDARDS_CHECKLIST.md
   └── Generate compliance report

2. ADAPT
   └── Propose necessary modifications
   └── Explain WHY each change is needed
   └── Get user approval

3. PROCEED
   └── Follow standard DEVELOP → DEPLOY flow
```

---

## 4. Security Standards

### 4.1 Credential Management

| Do | Don't |
|----|-------|
| Store secrets in `/var/lib/nhi/secrets/` | Put passwords in code |
| Use Age encryption for sensitive data | Commit `.env` files with secrets |
| Access via `nhi vault get <path>` | Share credentials in plain text |
| Rotate keys periodically | Use same password everywhere |

### 4.2 SSH Access

- **User:** Always `ai-agent`
- **Authentication:** SSH key-based only
- **Sudo:** Allowed for specific commands (NOPASSWD configured)
- **Pattern:** `ssh ai-agent@<IP from registry> "command"`

### 4.3 Network Security

- All services behind internal network
- External access only through reverse proxy
- HTTPS for all external endpoints
- Internal services can use HTTP

---

## 5. Documentation Standards

### 5.1 Required Documentation

| Document | Location | Purpose |
|----------|----------|---------|
| `project_manifest.md` | Project root | NHI integration metadata |
| [README.md](file:///C:/Users/Roberto/.gemini/antigravity/brain/935e8884-9cda-492f-b3c5-fed3cf3ce783/temp_nhi_core/README.md) | Project root | Getting started guide |
| `architecture.md` | `/docs/` | Technical decisions |
| API docs | Inline or `/docs/api/` | Endpoint documentation |

### 5.2 Manifest Structure

Every service MUST have a manifest in the NHI registry:

```yaml
service:
  name: "service-name"
  description: "What this service does"
  version: "1.0.0"

deployment:
  lxc_id: 110
  ip: "192.168.1.110"
  ports:
    - 8000  # API
    - 9100  # Metrics

dependencies:
  - postgresql
  - redis

health:
  endpoint: "/health"
  interval: 30s

owner: "ai-agent"
```

---

## 6. Testing Standards

### 6.1 Minimum Requirements

| Type | Coverage | When |
|------|----------|------|
| Unit tests | Core business logic | Before commit |
| Integration tests | API endpoints | Before deploy |
| Health checks | Service availability | After deploy |

### 6.2 Health Endpoint

Every service MUST expose:

```
GET /health

Response:
{
  "status": "healthy",
  "version": "1.0.0",
  "uptime": "2h30m",
  "dependencies": {
    "database": "connected",
    "redis": "connected"
  }
}
```

---

## 7. Deployment Standards

### 7.1 Container Requirements

- **Base image:** Official images only (python:3.11-slim, node:20-alpine)
- **Multi-stage builds:** Required for production
- **Non-root user:** Execute as non-root inside container
- **Labels:** Include NHI metadata labels

### 7.2 Docker Compose Standards

```yaml
services:
  app:
    build: ./docker
    container_name: project-name-api
    restart: unless-stopped
    environment:
      - LOG_LEVEL=info
    labels:
      - "nhi.service=project-name"
      - "nhi.version=1.0.0"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
```

### 7.3 Post-Deployment Checklist

- [ ] Service responds on expected port
- [ ] Health endpoint returns healthy
- [ ] Logs accessible via `journalctl` or `docker logs`
- [ ] Manifest registered in NHI
- [ ] Context regenerated (wait for hourly cron or force)
- [ ] .cursorrules shows new service

---

## 8. Error Handling

### 8.1 When Things Go Wrong

| Situation | Action |
|-----------|--------|
| Service won't start | Check logs first: `journalctl -u service-name` |
| Port conflict | Consult registry for allocated ports |
| Permission denied | Verify ai-agent ownership |
| Secret not found | Check vault path exists |

### 8.2 Rollback Procedure

1. Stop failing service
2. Restore previous container image
3. Verify health
4. Investigate root cause
5. Document lesson learned

---

## 9. Integration with AI Agents

### 9.1 What AI Agents Read

1. **[.cursorrules](file:///n:/.cursorrules)** - Compact operational rules
2. **Service registry** - Available services and IPs
3. **Project manifests** - Project-specific context

### 9.2 What AI Agents Should Do

- Consult [.cursorrules](file:///n:/.cursorrules) before ANY remote operation
- Never guess IPs, ports, or service names
- Follow workflows in `.agent/workflows/`
- Create manifests for new services
- Update documentation after changes

### 9.3 What AI Agents Should NOT Do

- Hardcode any infrastructure values
- Store credentials in code
- Skip the compliance check for external designs
- Deploy without health verification
- Modify production without approval

---

*NHI Methodology v1.0 - The foundation for AI-assisted homelab management*
