# üß† NHI Operational Rules

> **Philosophy**: Logic here, Data elsewhere.
> **Last Updated**: {timestamp}

---

# üõë CRITICAL PROTOCOL (READ FIRST)

**PREREQUISITE**: Before ANY 'Planning' or 'Execution' phase, you **MUST**:
1.  **READ** `/opt/nhi-core/docs/NHI_STANDARDS_CHECKLIST.md`.
2.  **INCLUDE** a "Pre-flight Check" item in your `task.md`.
3.  **ABORT** if you cannot verify compliance with NHI Standards.

**VIOLATION OF THIS PROTOCOL IS A CRITICAL FAILURE.**

---

## 1. üó∫Ô∏è Context & Data Sources (Dynamic SSOT)
Instead of hardcoding IPs and ports, **ALWAYS** refer to the following files:

| Type | Path | Content |
|------|------|---------|
| **Infrastructure** | `/var/lib/nhi/context/system-map.json` | **SSOT**. Nodes, LXC IPs, Ports, Resources. |
| **Config/Paths** | `/var/lib/nhi/config.yaml` | Core paths, Backups, Auth. |
| **Methodology** | `/opt/nhi-core/docs/NHI_METHODOLOGY.md` | **MANDATORY RULES**, not just reference. |
| **Projects Root** | `/home/ai-agent/projects/` | All user projects. Each is a separate Git repo. |
| **Project Docs** | `/home/ai-agent/projects/<project>/docs/` | Project-specific documentation, manifests, manuals. |

> **RULE**: Before any operation involving an IP or Port, read `system-map.json`. Do NOT guess.

---

## 2. üìÅ Project Structure
Each project in `/home/ai-agent/projects/<project>/` MUST follow:

```
<project>/
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ README.md              # Project overview
‚îÇ   ‚îú‚îÄ‚îÄ architecture.md        # Technical design
‚îÇ   ‚îî‚îÄ‚îÄ user_manual.md         # End-user documentation (if applicable)
‚îú‚îÄ‚îÄ src/                       # Source code
‚îú‚îÄ‚îÄ tests/                     # Test files
‚îú‚îÄ‚îÄ project_manifest.yaml      # NHI integration metadata
‚îî‚îÄ‚îÄ .git/                      # Independent Git repository
```

> **TO FIND PROJECT DOCS**: Look in `/home/ai-agent/projects/<project>/docs/`

---

## 3. üõ°Ô∏è Verification Protocol (STRICT)
When requested to verify, test, or check logs:
1.  **NEVER ASSUME SUCCESS**: Exit code 0 is the only truth.
2.  **SHOW YOUR WORK**: Output the raw command result to the user.
3.  **NO SILENT FAILURE**: Report every error immediately.

---

## 4. üîê SSH & Credentials
- **User**: `ai-agent` (defined in `config.yaml`).
- **Auth**: Key-based only.
- **Secrets**: 
    - **NEVER** output/log plaintext passwords. 
    - **ALWAYS** use Age/SOPS vault (`/var/lib/nhi/secrets/`).
    - **MUST** generate secrets on the fly and encrypt immediately.

---

## 5. üöÄ Development Workflow
1.  **PRE-FLIGHT**: verify `task.md` checklist against `NHI_STANDARDS_CHECKLIST.md`.
2.  **Read Context**: Load `system-map.json` to know the target IP.
3.  **Check Status**: Verify target LXC is `running` in `system-map.json`.
4.  **Connect**: SSH into the target IP using `ai-agent`.
5.  **Deploy/Edit**: Work in `/home/ai-agent/projects/<project>/` or via SSH.
6.  **Verify**: Apply Protocol #3.

---

## 6. ‚ö†Ô∏è Emergency Fallback
If `system-map.json` is unreadable or missing:
1.  **STOP**.
2.  Notify the user.
3.  Do NOT revert to hardcoded guesses.

---
*Generated by NHI-CORE v1.2 Context Generator (Template-based)*
