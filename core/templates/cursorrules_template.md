# üß† NHI Operational Rules

> **‚ö†Ô∏è AUTO-GENERATED FILE ‚ö†Ô∏è**
> This file is overwritten by `sync_catalog.py` every hour.
> **DO NOT EDIT THIS FILE DIRECTLY.**
> To add persistent rules, edit: **`/home/ai-agent/nhi-core-code/core/templates/cursorrules_template.md`**

> **Philosophy**: Logic here, Data elsewhere.
> **Last Updated**: {timestamp}

---

# üõë CRITICAL PROTOCOL (READ FIRST)

**PREREQUISITE**: Before ANY 'Planning' or 'Execution' phase, you **MUST**:
1.  **READ** `/opt/nhi-core/docs/NHI_STANDARDS_CHECKLIST.md`.
2.  **READ** `/opt/nhi-core/docs/AGENTS.md` for bootstrap protocol.
3.  **INCLUDE** a "Pre-flight Check" item in your `task.md`.
4.  **ABORT** if you cannot verify compliance with NHI Standards.

**VIOLATION OF THIS PROTOCOL IS A CRITICAL FAILURE.**

---

## 1. üó∫Ô∏è Context & Data Sources (Dynamic SSOT)
Instead of hardcoding IPs and ports, **ALWAYS** refer to the following files:

| Type | Path | Content |
|------|------|---------|
| **Infrastructure** | `/var/lib/nhi/context/system-map.json` | **SSOT**. Nodes, LXC IPs, Ports, Resources. |
| **Config/Paths** | `/var/lib/nhi/config.yaml` | Core paths, Backups, Auth. |
| **Methodology** | `/opt/nhi-core/docs/NHI_METHODOLOGY.md` | **MANDATORY RULES**, not just reference. |
| **Design System** | `/var/lib/nhi/design-system/registry.yaml` | Available themes/personalities for frontend. |
| **Getting Started** | `/opt/nhi-core/docs/GETTING_STARTED.md` | Bootstrap guide for new deployments. |
| **Quality Assurance** | `/opt/nhi-core/docs/QUALITY_ASSURANCE.md` | Linting & type-checking standards. |
| **Agent Protocol** | `/opt/nhi-core/docs/AGENTS.md` | Bootstrap protocol for AI agents. |
| **Implementation Guide** | `/opt/nhi-core/docs/NHI-CORE_Implementation_Guide_v1.1.md` | Technical implementation specifications. |
| **Projects Root** | `/home/ai-agent/projects/` | All user projects. Each is a separate Git repo. |
| **Project Docs** | `/home/ai-agent/projects/<project>/docs/` | Project-specific documentation, manifests, manuals. |

> **RULE**: Before any operation involving an IP or Port, read `system-map.json`. Do NOT guess.

---

## 2. üìÅ Project Structure
Each project in `/home/ai-agent/projects/<project>/` MUST follow:

```
<project>/
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ README.md              # Project overview
‚îÇ   ‚îú‚îÄ‚îÄ architecture.md        # Technical design
‚îÇ   ‚îî‚îÄ‚îÄ user_manual.md         # End-user documentation (if applicable)
‚îú‚îÄ‚îÄ src/                       # Source code
‚îú‚îÄ‚îÄ tests/                     # Test files
‚îú‚îÄ‚îÄ project_manifest.yaml      # NHI integration metadata
‚îî‚îÄ‚îÄ .git/                      # Independent Git repository
```

> **TO FIND PROJECT DOCS**: Look in `/home/ai-agent/projects/<project>/docs/`

---

## 3. üõ°Ô∏è Verification Protocol (STRICT)
When requested to verify, test, or check logs:
1.  **NEVER ASSUME SUCCESS**: Exit code 0 is the only truth.
2.  **SHOW YOUR WORK**: Output the raw command result to the user.
3.  **NO SILENT FAILURE**: Report every error immediately.

---

## 4. üîê SSH & Credentials

### 4.1 General Rules
- **User**: `ai-agent` (defined in `config.yaml`).
- **Auth**: Key-based only for SSH.
- **NEVER** output/log plaintext passwords.

### 4.2 Secrets Location & Retrieval
All secrets are encrypted with **Age/SOPS** and stored in:

| Secret Type | Path |
|-------------|------|
| Proxmox credentials | `/var/lib/nhi/secrets/infrastructure/proxmox.yaml` |
| Service credentials | `/var/lib/nhi/secrets/services/*.yaml` |
| Age encryption keys | `/var/lib/nhi/age/` |
| SOPS config | `/var/lib/nhi/.sops.yaml` |

### 4.3 How to Decrypt Secrets
```bash
# Ensure SOPS can find the keys (one-time setup)
mkdir -p ~/.config/sops/age
cat /var/lib/nhi/age/*.key > ~/.config/sops/age/keys.txt
chmod 600 ~/.config/sops/age/keys.txt

# Decrypt and view (DO NOT LOG OUTPUT)
cd /var/lib/nhi
sops --decrypt secrets/infrastructure/proxmox.yaml
```

### 4.4 Available Credentials (via decrypt)
- `proxmox_token` - API token for Proxmox automation
- `proxmox_root_password` - Root password for pct exec/SSH
- `github_token` - (if configured) GitHub PAT for repo access

### 4.5 SSH Access to Containers
- SSH public key: `/home/ai-agent/.ssh/id_ed25519.pub`
- For new containers: Use `deploy_complete.py` (auto-copies key)
- For existing: Use `setup_ssh_access.py` (requires Proxmox root access)

---

## 5. üé® NHI Design System (NHIDS)

**MANDATORY REFERENCE**:
> Before taking any design decision or writing frontend code, you **MUST** consult the Master Design Document:
> **`/home/ai-agent/nhi-core-code/docs/specs/NHI_DESIGN_SYSTEM.md`**
>
> **BEFORE CODING**: Check Section 8 of Design System. If a **Standard Functional Component** exists for your task (e.g., File Picking), you **MUST** use it. Do not reinvent the wheel.

**WHEN GENERATING FRONTEND UI**, you MUST follow these rules:

### 5.1 Available Personalities
Check `/var/lib/nhi/design-system/registry.yaml` or query `GET /design-system/info`:
- **system** - Dark admin theme (dashboards, monitoring, tools)
- **document** - Light professional theme (finance, data, docs)
- **media** - Neon dark theme (entertainment, landing pages)

### 5.2 CSS Integration
Include the bundled CSS from Control Plane (do NOT hardcode IP, use system-map):
```html
<link rel="stylesheet" href="http://{CORE_IP}:8000/design-system/bundle/{personality}.css">
```

### 5.3 STRICT RULES
1. **Use ONLY `.nhi-*` classes** - Never write inline `style=""` attributes.
2. **Use ONLY CSS variables** - `var(--nhi-color-*)`, `var(--nhi-space-*)`, etc.
3. **NEVER hardcode colors** - `#ff0000` is FORBIDDEN. Use `var(--nhi-color-error)`.
4. **NEVER include external CSS frameworks** - No Bootstrap, Material, arbitrary Tailwind.
5. **Declare personality in manifest**:
```yaml
# project_manifest.yaml
frontend:
  personality: "system"  # or "document" or "media"
```

### 5.4 Key Classes Available
- Layout: `.nhi-container`, `.nhi-grid`, `.nhi-flex`, `.nhi-card`
- Typography: `.nhi-title`, `.nhi-subtitle`, `.nhi-text-body`, `.nhi-code`
- Actions: `.nhi-btn-primary`, `.nhi-btn-secondary`, `.nhi-btn-danger`
- Feedback: `.nhi-alert-info`, `.nhi-badge-success`, `.nhi-status-dot`

### 5.5 Quality Assurance
Before committing any code changes:
1. **Run QA checks**: `make qa` (see `/opt/nhi-core/docs/QUALITY_ASSURANCE.md`)
2. **Verify compliance**: Ensure all quality gates pass
3. **Auto-fix when possible**: `make fix` for automatic corrections

**Quality gates include**:
- Python: ruff (linting) + mypy (type checking)
- JavaScript/TypeScript: eslint
- CSS/SCSS: prettier

----

## 6. üöÄ Development Workflow
1.  **PRE-FLIGHT**: verify `task.md` checklist against `NHI_STANDARDS_CHECKLIST.md`.
2.  **Read Context**: Load `system-map.json` to know the target IP.
3.  **Check Status**: Verify target LXC is `running` in `system-map.json`.
4.  **Connect**: SSH into the target IP using `ai-agent`.
5.  **Deploy/Edit**: Work in `/home/ai-agent/projects/<project>/` or via SSH.
6.  **Quality Check**: Run `make qa` to verify code quality (see `/opt/nhi-core/docs/QUALITY_ASSURANCE.md`).
7.  **Verify**: Apply Protocol #3.

---

## 7. ‚ö†Ô∏è Emergency Fallback
If `system-map.json` is unreadable or missing:
1.  **STOP**.
2.  Notify the user.
3.  Do NOT revert to hardcoded guesses.

---

## 8. üìä Data & Registry Management

### 8.1 Service Registry
Every LXC/VM in Proxmox **MUST** have a corresponding registry file:
- **Location**: `/var/lib/nhi/registry/services/<name>.yaml`
- **Schema**: `/var/lib/nhi/schemas/service.schema.json`
- **Template**: `/var/lib/nhi/templates/service_registry.yaml.template`

**Required fields**: `name`, `type`, `vmid`, `description`, `dependencies`

### 8.2 Project Manifest
Every project in `/home/ai-agent/projects/` **MUST** have:
- **File**: `project_manifest.yaml` in project root
- **Schema**: `/var/lib/nhi/schemas/manifest.schema.json`
- **Template**: `/var/lib/nhi/templates/project_manifest.yaml.template`

**Required fields**: `name`, `version`, `dependencies.services`

### 8.3 System Catalog
The comprehensive system state is available at:
- **API**: `GET /system/catalog`
- **File**: `/var/lib/nhi/context/system-catalog.json`

This shows: all machines, registry files, compliance status, dependencies.

### 8.4 Creating New Services
1. Create LXC in Proxmox ‚Üí **Auto-detected** in next scan
2. Create registry YAML: copy template and fill values
3. Declare dependencies in `dependencies.required/optional`
4. Verify: `GET /system/catalog` shows no compliance issues

### 8.5 Creating New Projects
1. Create folder in `/home/ai-agent/projects/<name>/`
2. Create `project_manifest.yaml` using template
3. Create `docs/README.md` (minimum documentation)
4. Declare dependencies in `dependencies.services`
5. Initialize git: `git init && git add . && git commit -m "Initial"`

### 8.6 Data Taxonomy & Backup (MANDATORY)
Future agents MUST classify data into three tiers and document it in `project_manifest.yaml`:

1.  **SEED (Backup)**: User config, secrets, preferences. Meaningless if lost.
    *   *Action*: Add path to `backup.persistence` list.
2.  **RECONSTRUCTIBLE (Exclude)**: Data generated by scripts (e.g., node_modules, system-map).
    *   *Action*: Exclude from backup. Ensure `restore_hooks` exist to regenerate it.
3.  **STATIC (Git)**: Source code, assets.
    *   *Action*: Do nothing. Reliance on Git.

**Manifest Requirement**:
```yaml
backup:
  persistence:
    - "/var/lib/app/config.json"
  restore_hooks:
    - "npm install"
    - "python regenerate_state.py"
```

### 8.7 Deploying New LXC (Complete Workflow)
Use the complete deploy script that handles everything:
```bash
python3 /opt/nhi-core/scripts/deploy_complete.py \
  --name myservice --vmid 180 --ip 192.168.1.180
```

---

## 9. üîÑ Git Workflow & Repository Management

**‚ö†Ô∏è CRITICAL**: Distinzione tra **Framework** (NHI-CORE) e **Progetti Utente**!

### 9.1 Context Awareness
**Prima di qualsiasi operazione Git**, identifica il contesto:

| Contesto | Path | Repository | Workflow | Token |
|----------|------|------------|----------|--------|
| **Framework** | `/opt/nhi-core` | `S3ph1r/nhi-core` | Manuale raro | Pre-configurato |
| **Progetto** | `/home/ai-agent/projects/*` | **Repo separato** | Standard utente | Condiviso |

### 9.2 GitHub Token Retrieval
```bash
# Recupera PAT condiviso da SOPS
sops --decrypt /var/lib/nhi/secrets/services/github.yaml
# Usa il valore github_token per configurare remote
```

### 9.3 New Project Setup Protocol
Quando crei un nuovo progetto in `/home/ai-agent/projects/`:

1. **Crea repository GitHub**: `nhi-<nomeprogetto>`
2. **Configura remote**: `git remote add origin https://TOKEN@github.com/USER/nhi-nome.git`
3. **Setup iniziale**: `git push -u origin main`
4. **Documenta**: Aggiorna `project_manifest.yaml` con repo URL

### 9.4 Standard Project Workflow
```bash
cd /home/ai-agent/projects/<nome>
git status                          # Check stato
git add -A                          # Stage changes  
git commit -m "feat: descrizione"   # Commit descrittivo
git push origin main               # Push quando pronto
```

### 9.5 Framework Development (AUTOMATED)
Il framework `/opt/nhi-core` ha **push automatico ogni ora** via cron:
- **Script**: `/opt/nhi-core/core/context/updater.py`
- **Log**: `/var/log/nhi/cron.log`
- **Trigger**: Modifiche a `/var/lib/nhi` (data) ‚Üí auto-commit+push

**Push manuale solo per emergenze**:
```bash
cd /opt/nhi-core
git status
git add -A  
git commit -m "system: descrizione modifica"
git push origin main
```

**‚ö†Ô∏è WARNING**: Modifiche framework richiedono estrema cautela!

### 9.6 Project vs Framework Decision Tree
```
Sei in /opt/nhi-core? 
  ‚Üì YES
  ‚Üí Framework development (raro, pericoloso)
  ‚Üì NO  
Sei in /home/ai-agent/projects/*?
  ‚Üì YES
  ‚Üí User project (normale sviluppo)
  ‚Üì NO
‚Üí Errore! Contatta amministratore.
```

Per workflow completo: **LEGGI** `/opt/nhi-core/docs/GIT_WORKFLOW.md`

This automatically:
1. Creates LXC via Proxmox API
2. Creates `ai-agent` user
3. Copies SSH public key (for remote scanning)
4. Creates skeleton registry entry
5. Updates system catalog

### 8.7 Runtime Dependency Scanning
Discover REAL runtime dependencies via:
```bash
GET /services/scan/runtime          # Scan all services
GET /services/scan/runtime/myservice  # Single service
```

This SSH into containers and reads active network connections.

> **RULE**: If a service/project doesn't have proper registry/manifest, it is NON-COMPLIANT.

---

## 9. ‚úÖ Quality Assurance (QA) ‚Äì MANDATORY before ‚Äúcompleted‚Äù

**Pre-requisite**: ogni task che modifica codice deve superare i controlli di qualit√†.

### 9.1 Comandi da eseguire prima di dichiarare ‚Äúcompletato‚Äù
```bash
# Se il progetto NON ha Makefile ‚Üí copia template
 cp -r /opt/nhi-core/quality-template/* .
# Esegui sempre
 make qa          # verifica solo
# oppure, se vuoi auto-fix
 make fix
```

### 9.2 Regole attive (step 0 ‚Äì base)
- Python: ruff (E,F,I) + mypy (non-strict)
- JS/CSS: prettier default + eslint raccomandato

### 9.3 Se i controlli falliscono
- Correggi gli errori riportati
- Se non sai come ‚Üí chiedi all‚Äôutente
- **Non** marcare il task come ‚Äúcompleted‚Äù finch√© `make qa` restituisce exit-code ‚â† 0

### 9.4 Documentazione completa
Vedi: `/opt/nhi-core/quality-template/QUALITY_GUIDE.md`

---
*Generated by NHI-CORE v1.2 Context Generator (Template-based)*

